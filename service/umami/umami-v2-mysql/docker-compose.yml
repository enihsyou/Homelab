services:
  umami:
    image: docker.umami.is/umami-software/umami:mysql-latest
    deploy:
      resources:
        limits:
          cpus: ${CPUS}
          memory: ${MEMORY_LIMIT}
    ports:
      - ${HOST_IP}:${WEB_HTTP_PORT}:3000
    environment:
      DATABASE_URL: mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DATABASE}
      REDIS_URL: redis://default:${REDIS_PASSWORD}@redis:6379
      # generate with $( openssl rand -base64 32 )
      APP_SECRET: ${APP_SECRET}
      # If on Tencent EdgeOne, uncomment the following line to reveal the real client IP to Umami
      # CLIENT_IP_HEADER: Eo-Connecting-Ip
    extra_hosts:
      # If connect to MySQL on the Docker host, set MYSQL_HOST to 'mysql'
      mysql: host-gateway
    volumes:
      # https://github.com/umami-software/umami/issues/3845
      - /dev/null:/app/.env:ro
    depends_on:
      - redis
    networks:
      - umami_net
    init: true
    healthcheck:
      test: ["CMD", "curl -f http://localhost:3000/api/heartbeat"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 15s
  redis:
    image: redis:7-alpine
    # BT-Panel remote connection requires Redis AUTH to be enabled
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    deploy:
      resources:
        limits:
          cpus: 0.5
          memory: 256MB
    networks:
      # Enabling access redis server from Linux Docker host via
      # redis-cli -h $(docker container inspect umami-redis-1 -f '{{.NetworkSettings.Networks.umami_umami_net.IPAddress}}')
      - umami_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 15s

networks:
  umami_net:
